<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/styleadpage.css">
  <link rel="shortcut icon" type="image" href="/image/logo.png">
  <title>admin page</title>
  <!-- bootstrap link -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://getbootstrap.com/docs/5.3/assets/css/docs.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!--  -->
  <!-- Import bootstrap cdn -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
  <!-- Import jquery cdn -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous">
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous">
  </script>
  <!--  -->
  <style>
    .single_coupon_div {
      width: 90%;
      min-height: 90px;
      margin: 1rem 0 0 0;
      color: #fff;
      position: relative;
      border-radius: 12px;
      border: 1px solid rgb(68, 30, 30);
      background-color: rgb(113, 88, 88);
      box-shadow: 5px 5px 10px black;
      display: flex;
      text-shadow: 2px 2px 3px black;

    }

    .single_coupon_div:hover {
      background-color: rgb(126, 95, 95);
    }

    .box {
      width: 90%;
    }

    .scrollable-content {
      position: relative;
    }

    .add_newCoupon {
      background-color: transparent;
      outline: none;
      border: none;
      color: #ffffff;
      text-shadow: 2px 2px 3px black;
      position: absolute;
      right: 1rem;
    }


    .add_newCoupon_form_div {
      width: 25rem;
      min-height: 15rem;
      border: 2px solid #fff;
      box-shadow: 4px 4px 6px black;
      margin: 4rem auto;
      border-radius: 10px;
      padding: 1rem;
      display: none;
      position: relative;
    }

    .offer_rate_div {
      width: 80%;
      min-height: 3rem;
      display: flex;
      margin: .5rem 0 0 2rem;
      text-transform: capitalize;
      padding: .1rem 0 0 .5rem;
      color: #c3faa5;
      text-shadow: 2px 2px 3px black;

    }
    

    .number_input {
      background-color: transparent;
      color: #fff;
      width: 50px;
      height: 30px;
      outline: none;
      text-shadow: 2px 2px 3px black;
      border: .5px solid #9f9f9f;
      border-radius: 5px;
      margin: 0 0 0 .2rem;


    }

    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      opacity: 1;
    }

    .coupon_name_tag {
      background-color: transparent;
      color: #fff;
      font-size: 12px;
      padding: .2rem 0 0 .5rem;
      width: 80%;
      cursor: pointer;
      border-radius: 12px;
      margin: 1rem 0 0 2rem;
    }

    .reason_for_return {
      background-color: transparent;
      color: #fff;
      font-size: 12px;
      padding: .5rem 0 0 .5rem;
      width: 80%;
      cursor: pointer;
      border-radius: 12px;
      margin: 1rem 0 0 2rem;
    }

    .reason_for_return::placeholder {
      color: #fff;
    }

    .coupon_name_tag::placeholder {
      color: #fff;
    }

    .reason_for_return:focus {
      outline: none;
      cursor: pointer;
    }

    .date_div {
      font-size: 12px;
      color: #fff;
      text-shadow: 2px 2px 3px black;

    }

    .product_footer_data_div {
      width: 80%;
      margin: .5rem 0 0 3rem;
      display: flex;
      min-height: 30px;
    }

    .apply_offer,
    .cancel_offer {
      background-color: transparent;
      border: none;
      outline: none;
      color: rgb(219, 145, 145);
      margin: 0 0 0 3rem;
    }

    .validation_error {
      position: absolute;
      color: rgb(255, 106, 106);
      text-shadow: 2px 2px 3px black;
      bottom: -3rem;
      left: 1rem;
      display: none;
    }

    .details_coupon {
      flex: 0 0 30%;
      padding: 1rem 0 0 1rem;
    }

    .date_coupon {
      flex: 0 0 50%;
      padding: 1.7rem 2.3rem;
    }

    .action_coupon {
      flex: 0 0 20%;
      color: rgb(255, 123, 123);
      padding: 1.7rem 2rem;
      font-size: 14px;
      user-select: none;
    }

    .discription_coupons {
      width: 90%;
      text-wrap: wrap;
      font-size: 13px;
      margin-top: -1rem;
    }

    .button {
      width: 100%;
      padding: 6px;
      margin-bottom: 5px;
      text-align: center;
      background-color: rgb(136, 118, 118);
      color: #fff;
      border: none;
      cursor: pointer;
      text-shadow: 2px 2px 3px black;
      box-shadow: 4px 4px 5px black;
      transition: background-color, .3s;
    }
    .offerTXT{
      font-size: 13px;
      margin:5px  0 0 0;
    }
    .min_value{
      background-color: transparent;
      color: #fff;
      width: 50px;
      height: 30px;
      outline: none;
      text-shadow: 2px 2px 3px black;
      border: .5px solid #9f9f9f;
      border-radius: 5px;
      margin: 0 0 0 .2rem;
    }
    .usage_count{
      background-color: transparent;
      color: #fff;
      width: 50px;
      height: 30px;
      outline: none;
      text-shadow: 2px 2px 3px black;
      border: .5px solid #9f9f9f;
      border-radius: 5px;
      margin: 0 0 0 .5rem;
    }
    .max_discount{
      background-color: transparent;
      color: #fff;
      width: 70px;
      height: 30px;
      outline: none;
      text-shadow: 2px 2px 3px black;
      border: .5px solid #9f9f9f;
      border-radius: 5px;
      margin: 0 0 0 .2rem;
    }
    .offer_requirement_div {
      width: 80%;
      min-height: 3rem;
      display: flex;
      margin: .5rem 0 0 2rem;
      text-transform: capitalize;
      padding: .1rem 0 0 .5rem;
      color: #c3faa5;
      text-shadow: 2px 2px 3px black;

    }
    .min_txt{
      font-size:12px;
       text-align: center; 
       margin:-3px 2px 0 .5rem;
    }
  </style>


</head>

<body>
  <div class="container_main ">
    <!-- left bar  -->
    <div class="sidebar">
      <!-- Your sidebar content goes here -->

      <div class="profile_bar">
        <form class="circle" action="/logout" method="get">
          <img src="/image2/admin.png" alt="Profile Image">
          <p class="admintag">admin </p>
          <button id="logoutbtn" type="submit"><img width="20px" src="/image2/logout.png" alt="logout"></button>
        </form>
      </div>
      <a href="/admin/adminDashboard"><button id="toggleButton button" class="button action_usermanagement" style=" background-color: rgb(98, 77, 77);">Dashboard</button></a>
      <a href="/admin/usermanagement"><button id="toggleButton button" class="button action_usermanagement" style=" background-color: rgb(98, 77, 77);">Users</button></a>
      <a href="/admin/productmangement"><button class="button" style=" background-color: rgb(98, 77, 77);">Products</button></a>
      <a href="/admin/categorymanagement"><button class="button" style=" background-color: rgb(98, 77, 77);">Categorys</button></a>
      <a href="/admin/ordermanagement"><button class="button" style=" background-color: rgb(98, 77, 77);">Orders</button></a>
      <a href="/admin/offermanagement/product"><button class="button" style=" background-color: rgb(98, 77, 77);">Offers</button></a>
      <a href="/admin/couponmanagement"><button class="button" style=" background-color: rgb(69, 45, 45);">Coupons</button></a>
    </div>
    <!--  -->

    <form class="search-bar" action="/admin/usermanagement/search" method="get">
      <h1>Coupons</h1>
      <input type="text" name="key" id="search-input" placeholder="Search...">
      <button type="submit" id="search-button">
        <img src="/image2/search.png" width="30px" alt="Search Icon">
      </button>
    </form>

    <!-- Your scrollable content goes here -->

    <div class="scrollable-content">
      <button class="add_newCoupon" onclick="addModel()">
        ADD NEW
      </button>
      <div class="box">
        <% couponsList.forEach(coupon=> { %>
        <div class="single_coupon_div">
          <div class="details_coupon">
            <p class="name_coupon"><%=coupon.couponName%> <span style="font-size: 17px ; color: #c3faa5;">(<%=coupon.couponOff%>% OFF)</span></p>

            <p class="discription_coupons"><%=coupon.description%></p>
          </div>
          <div class="date_coupon">
            From <span style="font-size:13px; color: #a3eb7b;">(<%=new Date(coupon.validFrom).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }) %>)</span> To <span style="font-size:13px; color: rgb(241, 126, 126);">(<%=new Date(coupon.validTo).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }) %>)</span>
          </div>
          <div class="action_coupon">
            <span style="cursor: pointer;" onclick="remove('<%=coupon._id%>')">REMOVE</span>
          </div>
        </div>
        <% }) %>
      </div>


      <div class="add_newCoupon_form_div">
        <input type="text" name="couponName" placeholder="Coupon Name" required class="coupon_name_tag">

        <div class="offer_rate_div">
          offer rate (%)<input type="number" id="quantity" name="quantity" min="1" max="99" class="number_input" autocomplete="off" value="10" onkeydown="return handleKeyPress(event)">
          <span class="min_txt">usage <br> count</span><input type="number" class="usage_count" min="1" max="99" value="4" autocomplete="off" onkeydown="return handleKeyPress(event)">

        </div>
        <div class="offer_requirement_div">
          <span class="min_txt">min cart <br> value</span><input type="number" class="min_value" value="200">
          <span class="min_txt">max discount <br> amount</span><input type="number" class="max_discount" value="2500">
        </div>
        

        <textarea class="reason_for_return" placeholder="Coupon Description"></textarea>
        <div class="date_div">
          <label for="validFrom">Valid From:</label>
          <input type="date" name="validFrom" required>

          <label for="validTo">Valid To:</label>
          <input type="date" name="validTo" required>
        </div>


        <div class="product_footer_data_div">
          <button class="cancel_offer" onclick="cancelBtn()">CANCEL</button>
          <button class="apply_offer" style="color: #c3faa5;" onclick="addCoupon()">ADD</button>
        </div>
        <p class="validation_error"></p>

      </div>

    </div>

    <div class="errormsg" style="display: none;">
      Fail to connect database check your network !
    </div>





    <!-- ////////////////////////SCRIPT AREA/////////////////////////////// -->
    <!-- offer apply fetch req -->
    <script>
      function addCoupon() {
        const couponName = document.querySelector(".coupon_name_tag").value.trim();
        const offerRate = parseInt(document.querySelector(".number_input").value);
        const usageCount = parseInt(document.querySelector(".usage_count").value);
        const minValue = parseInt(document.querySelector(".min_value").value);
        const maxDiscount = parseInt(document.querySelector(".max_discount").value);
        const description = document.querySelector(".reason_for_return").value.trim();
        const validFrom = document.querySelector('input[name="validFrom"]').value;
        const validTo = document.querySelector('input[name="validTo"]').value;

        // Check if coupon name is less than or equal to 4 characters
        if (!(couponName.length === 5)) {
          document.querySelector(".validation_error").style.display = "block";
          document.querySelector(".validation_error").textContent = "Coupon name must be 5 characters.";
          return false;
        }

        // Check if coupon name is already taken
        if (couponName) {
          const data = {
            couponName,
          };
          fetch('/admin/couponAvailability', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(data)
            })
            .then(response => {
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then(data => {
              if (data.status === true) {
                document.querySelector(".validation_error").style.display = "block";
                document.querySelector(".validation_error").textContent = "Coupon name already taken.";
                throw new Error('Coupon name already taken.');
              } else {
                // Continue with other validations and second fetch
                continueWithSecondFetch();
              }
            })
            .catch(e => {
              console.log('There has been a problem with your fetch operation: ' + e.message);
            });
        }

        // Other validation checks...

        function continueWithSecondFetch() {
          // Check if offer rate is less than 1 or greater than 99
          if (offerRate < 1 || offerRate > 99) {
            document.querySelector(".validation_error").style.display = "block";
            document.querySelector(".validation_error").textContent = "Offer rate must be between 1 and 99.";
            return false;
          }

          if (usageCount < 1) {
            document.querySelector(".validation_error").style.display = "block";
            document.querySelector(".validation_error").textContent = "Usage Count must be positive.";
            return false;
          }
          if (minValue < 1) {
            document.querySelector(".validation_error").style.display = "block";
            document.querySelector(".validation_error").textContent = "min cart value must be positive.";
            return false;
          }
          if (maxDiscount < 1) {
            document.querySelector(".validation_error").style.display = "block";
            document.querySelector(".validation_error").textContent = "Max Discount Amount must be positive.";
            return false;
          }

          if (maxDiscount < minValue) {
            document.querySelector(".validation_error").style.display = "block";
            document.querySelector(".validation_error").textContent = "Enter a valid max discount amount.";
            return false;
          }


          // Check if coupon description is empty
          if (description.length <= 1) {
            document.querySelector(".validation_error").style.display = "block";
            document.querySelector(".validation_error").textContent = "Coupon description cannot be empty.";
            return false;
          }

          if (validFrom > validTo) {
            document.querySelector(".validation_error").style.display = "block";
            document.querySelector(".validation_error").textContent = "Valid From date must be earlier than Valid To date.";
            return false;
          }

          // Other validations...

          const data = {
            couponName,
            offerRate,
            description,
            validFrom,
            validTo,
            maxDiscount,
            minValue,
            usageCount,
          };

          // Second fetch request
          fetch('/admin/couponmanagement', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(data)
            })
            .then(response => {
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then(data => {
              if (data.status) {
                window.location.reload();
              }
            })
            .catch(e => {
              console.log('There has been a problem with your fetch operation: ' + e.message);
            });
        }
      }
    </script>
    <!-- _____________________ -->

    <!-- remove coupon  -->
    <script>
      function remove(id) {
        const data = {
          id,
        };
        console.log(data);
        fetch('/admin/couponmanagement', {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          })
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            if (data.status) {
              window.location.reload();
            }
          })
          .catch(e => {
            console.log('There has been a problem with your fetch operation: ' + e.message);
          });
      }
    </script>
    <!-- ______________ -->

    <!-- add offer model  -->
    <script>
      function addModel() {
        document.querySelector(".box").style.display = "none";
        document.querySelector(".add_newCoupon_form_div").style.display = "block";
      }

      function cancelBtn() {
        document.querySelector(".box").style.display = "block";
        document.querySelector(".add_newCoupon_form_div").style.display = "none";
      }
    </script>
    <!-- ________________ -->

    <!-- status update  -->

    <script>
      function errorMsg() {
        document.querySelector('.errormsg').textContent = data.message;
        document.querySelector('.errormsg').style.display = "block";
        document.querySelector('.errormsg').style.animationPlayState = 'running';

        setTimeout(function() {
          document.querySelector('.errormsg').style.animationPlayState = 'paused';
          document.querySelector('.errormsg').style.animationName = "hide"
          document.querySelector('.errormsg').style.animationPlayState = 'running';
          setTimeout(() => {
            window.location.reload()
          }, 150);
        }, 2000);
      }
    </script>
    <!--           _______          -->

    <!--        copy of id  -->
    <script>
      function copyToClipboard() {
        var orderID = document.getElementById("orderID").innerText;
        navigator.clipboard.writeText(orderID).then(function() {
          console.log('Order ID copied to clipboard');
        }).catch(function(err) {
          console.error('Could not copy text: ', err);
        });
      }
    </script>
    <!-- __________________ -->

    <!-- privent typing  -->
    <script>
      function handleKeyPress(event) {
        // Allow arrow keys (37, 38, 39, 40) and prevent other key inputs
        if (event.keyCode >= 37 && event.keyCode <= 40) {
          return true;
        } else {
          event.preventDefault();
          return false;
        }
      }
    </script>
    <!-- ________________ -->


</body>

</html>